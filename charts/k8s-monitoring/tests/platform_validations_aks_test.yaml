# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Validations - Platforms - AKS
templates:
  - validations.yaml
tests:
  - it: asks you to set podAnnotations on Alloy on AKS clusters
    set:
      cluster: {name: aks-cluster}
      destinations: [{name: prom, type: prometheus, url: http://prometheus-server.prometheus.svc:9090}]
      clusterMetrics: {enabled: true}
      alloy-metrics: {enabled: true}
    kubernetesProvider:
      scheme:
        "v1/Node":
          gvr:
            version: "v1"
            resource: "nodes"
          namespaced: false
      objects:
        - kind: Node
          apiVersion: v1
          metadata:
            name: node1
            labels:
              kubernetes.azure.com/cluster: aks-cluster
    asserts:
      - failedTemplate:
          errorMessage: |-
            This Kubernetes cluster appears to be Azure AKS.
            To ensure connectivity to the API server, please set:
            alloy-metrics:
              controller:
                podAnnotations:
                  kubernetes.azure.com/set-kube-service-host-fqdn: "true"

  - it: asks you to set podAnnotations on kube-state-metrics on AKS clusters
    set:
      cluster: {name: aks-cluster}
      destinations: [{name: prom, type: prometheus, url: http://prometheus-server.prometheus.svc:9090}]
      clusterMetrics: {enabled: true}
      alloy-metrics:
        enabled: true
        controller:
          podAnnotations:
            kubernetes.azure.com/set-kube-service-host-fqdn: "true"
    kubernetesProvider:
      scheme:
        "v1/Node":
          gvr:
            version: "v1"
            resource: "nodes"
          namespaced: false
      objects:
        - kind: Node
          apiVersion: v1
          metadata:
            name: node1
            labels:
              kubernetes.azure.com/cluster: aks-cluster
    asserts:
      - failedTemplate:
          errorMessage: |-
            This Kubernetes cluster appears to be Azure AKS.
            To ensure connectivity to the API server, please set:
            clusterMetrics:
              kube-state-metrics:
                podAnnotations:
                  kubernetes.azure.com/set-kube-service-host-fqdn: "true"

  - it: works when the annotations are set correctly
    set:
      cluster: {name: aks-cluster}
      destinations: [{name: prom, type: prometheus, url: http://prometheus-server.prometheus.svc:9090}]
      clusterMetrics:
        enabled: true
        kube-state-metrics:
          podAnnotations:
            kubernetes.azure.com/set-kube-service-host-fqdn: "true"
      alloy-metrics:
        enabled: true
        controller:
          podAnnotations:
            kubernetes.azure.com/set-kube-service-host-fqdn: "true"
    kubernetesProvider:
      scheme:
        "v1/Node":
          gvr:
            version: "v1"
            resource: "nodes"
          namespaced: false
      objects:
        - kind: Node
          apiVersion: v1
          metadata:
            name: node1
            labels:
              kubernetes.azure.com/cluster: aks-cluster
    asserts:
      - notFailedTemplate: {}

  - it: works when using collectorCommon
    set:
      cluster: {name: aks-cluster}
      destinations: [{name: prom, type: prometheus, url: http://prometheus-server.prometheus.svc:9090}]
      clusterMetrics:
        enabled: true
        kube-state-metrics:
          podAnnotations:
            kubernetes.azure.com/set-kube-service-host-fqdn: "true"
      alloy-metrics:
        enabled: true
      alloy-singleton:
        enabled: true
        extraConfig: "// This is required to enable this Alloy instance"
      collectorCommon:
        alloy:
          controller:
            podAnnotations:
              kubernetes.azure.com/set-kube-service-host-fqdn: "true"
    kubernetesProvider:
      scheme:
        "v1/Node":
          gvr:
            version: "v1"
            resource: "nodes"
          namespaced: false
      objects:
        - kind: Node
          apiVersion: v1
          metadata:
            name: node1
            labels:
              kubernetes.azure.com/cluster: aks-cluster
    asserts:
      - notFailedTemplate: {}
