# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Destinations - OTLP
templates:
  - alloy-config.yaml
tests:
  - it: creates the Alloy components for an OTLP destination
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to disable retry on failure
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          retryOnFailure:
            enabled: false
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to use basic authentication
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          auth:
            type: basic
            username: testuser
            password: testpassword
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to use basic authentication with a numeric username
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          auth:
            type: basic
            username: 12345
            password: testpassword
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to configure include block with resources
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          processors:
            attributes:
              include:
                matchType: "strict"
                resources:
                  - key: "service.name"
                    value: "api-gateway"
                  - key: "service.name"
                    value: "payment-service"
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to configure include block with all fields
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          processors:
            attributes:
              include:
                matchType: "regexp"
                services: ["service1", "service2"]
                spanNames: ["span1", "span2"]
                spanKinds: ["SPAN_KIND_SERVER", "SPAN_KIND_CLIENT"]
                logBodies: ["error", "warning"]
                logSeverityTexts: ["ERROR", "WARN"]
                metricNames: ["metric1", "metric2"]
                resources:
                  - key: "service.name"
                    value: "api-gateway"
                  - key: "deployment.environment"
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to configure exclude block
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          processors:
            attributes:
              exclude:
                matchType: "strict"
                services: ["test-service"]
                resources:
                  - key: "k8s.namespace.name"
                    value: "kube-system"
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to configure both include and exclude blocks
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: otlp
          url: https://otlp.example.com
          processors:
            attributes:
              include:
                matchType: "strict"
                services: ["api-gateway"]
              exclude:
                matchType: "regexp"
                spanNames: ["^health.*"]
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]
