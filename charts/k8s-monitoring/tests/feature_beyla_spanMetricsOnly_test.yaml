# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Feature - Auto-Instrumentation - spanMetricsOnly Flag
templates:
  - beyla-config.yaml
tests:
  # Test 1: Default behavior - spanMetricsOnly not set (should default to false)
  - it: does not set spanMetricsOnly by default and includes otel_traces_export when applicationObservability is enabled
    set:
      cluster: {name: test-cluster}
      autoInstrumentation: {enabled: true}
      applicationObservability:
        enabled: true
        receivers:
          otlp:
            grpc:
              enabled: true
      alloy-receiver:
        enabled: true
        alloy:
          extraPorts:
            - name: otlp-grpc
              port: 4317
              targetPort: 4317
              protocol: TCP
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "otel_traces_export:"

  # Test 2: spanMetricsOnly explicitly set to false (backward compatible)
  - it: includes otel_traces_export when spanMetricsOnly is explicitly false
    set:
      cluster: {name: test-cluster}
      autoInstrumentation:
        enabled: true
        spanMetricsOnly: false
      applicationObservability:
        enabled: true
        receivers:
          otlp:
            grpc:
              enabled: true
      alloy-receiver:
        enabled: true
        alloy:
          extraPorts:
            - name: otlp-grpc
              port: 4317
              targetPort: 4317
              protocol: TCP
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "otel_traces_export:"

  # Test 3: spanMetricsOnly set to true - should NOT include otel_traces_export
  - it: does not include otel_traces_export when spanMetricsOnly is true
    set:
      cluster: {name: test-cluster}
      autoInstrumentation:
        enabled: true
        spanMetricsOnly: true
      applicationObservability:
        enabled: true
        receivers:
          otlp:
            grpc:
              enabled: true
      alloy-receiver:
        enabled: true
        alloy:
          extraPorts:
            - name: otlp-grpc
              port: 4317
              targetPort: 4317
              protocol: TCP
    asserts:
      - isKind:
          of: ConfigMap
      - notMatchRegex:
          path: data["beyla-config.yml"]
          pattern: "otel_traces_export:"
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "prometheus_export:"

  # Test 4: spanMetricsOnly true without applicationObservability (no change expected)
  - it: works correctly when spanMetricsOnly is true without applicationObservability
    set:
      cluster: {name: test-cluster}
      autoInstrumentation:
        enabled: true
        spanMetricsOnly: true
    asserts:
      - isKind:
          of: ConfigMap
      - notMatchRegex:
          path: data["beyla-config.yml"]
          pattern: "otel_traces_export:"
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "prometheus_export:"

  # Test 5: Verify prometheus_export features are still present with spanMetricsOnly
  - it: maintains prometheus_export features when spanMetricsOnly is true
    set:
      cluster: {name: test-cluster}
      autoInstrumentation:
        enabled: true
        spanMetricsOnly: true
      applicationObservability:
        enabled: true
        receivers:
          otlp:
            grpc:
              enabled: true
      alloy-receiver:
        enabled: true
        alloy:
          extraPorts:
            - name: otlp-grpc
              port: 4317
              targetPort: 4317
              protocol: TCP
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "application_span"
      - matchRegex:
          path: data["beyla-config.yml"]
          pattern: "application_service_graph"

  # Test 6: Verify cluster name is still set correctly
  - it: sets cluster name correctly with spanMetricsOnly
    set:
      cluster: {name: my-custom-cluster}
      autoInstrumentation:
        enabled: true
        spanMetricsOnly: true
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: data["beyla-config.yml"]
          value: |-
            attributes:
              kubernetes:
                cluster_name: my-custom-cluster
                enable: true
            discovery:
              exclude_services:
              - exe_path: .*alloy.*|.*otelcol.*|.*beyla.*
              services:
              - k8s_namespace: .
            filter:
              network:
                k8s_dst_owner_name:
                  not_match: '{kube*,*jaeger-agent*,*prometheus*,*promtail*,*grafana-agent*}'
                k8s_src_owner_name:
                  not_match: '{kube*,*jaeger-agent*,*prometheus*,*promtail*,*grafana-agent*}'
            internal_metrics:
              prometheus:
                path: /internal/metrics
                port: 9090
            prometheus_export:
              features:
              - application
              - network
              - application_service_graph
              - application_span
              - application_host
              path: /metrics
              port: 9090
