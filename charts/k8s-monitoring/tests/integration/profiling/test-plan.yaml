---
apiVersion: helm-chart-toolbox.grafana.com/v1
kind: TestPlan
name: profiling

subject:
  releaseName: k8smon
  path: ../../..
  valuesFile: values.yaml

cluster:
  type: kind

dependencies:
  - preset: pyroscope
  - preset: grafana
    overrides:
      datasources:
        datasources.yaml:
          apiVersion: 1
          datasources:
            - name: Pyroscope
              type: grafana-pyroscope-datasource
              url: http://pyroscope.pyroscope.svc:4040
              isDefault: true

tests:
  - type: query-test
    values:
      tests:
        - env:
            CLUSTER: profiling-feature-test
            PROFILECLI_URL: http://pyroscope.pyroscope.svc:4040
          queries:
            - query: '{cluster="$CLUSTER", service_name="profile-source", service_namespace="default", app_kubernetes_io_name="alloy"}'
              type: pyroql
            - query: '{cluster="$CLUSTER", service_name="pyroscope", service_namespace="pyroscope", app_kubernetes_io_name="pyroscope"}'
              type: pyroql
