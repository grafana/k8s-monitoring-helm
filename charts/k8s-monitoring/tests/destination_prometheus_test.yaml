# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Destinations - Prometheus
templates:
  - alloy-config.yaml
tests:
  - it: creates the Alloy components for an Prometheus destination
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to disable retry on HTTP 429
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          queueConfig:
            retryOnHttp429: false
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to use basic authentication
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          auth:
            type: basic
            username: testuser
            password: testpassword
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: allows you to use basic authentication with a numeric username
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          auth:
            type: basic
            username: 12345
            password: testpassword
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: supports metric enrichment with simple labels
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          metricEnrichment:
            namespaceLabels: [team]
            podLabels: [color]
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: supports metric enrichment with labels containing special characters
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          metricEnrichment:
            namespaceLabels:
              - field.cattle.io/projectId
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]

  - it: supports metric enrichment with explicit label renaming
    set:
      cluster: {name: test-cluster}
      alloy-singleton: {enabled: true, extraConfig: " ", includeDestinations: ["test"]}
      selfReporting: {enabled: false}
      destinations:
        - name: test
          type: prometheus
          url: https://prometheus.example.com
          metricEnrichment:
            namespaceLabels:
              - team
              - name: field.cattle.io/projectId
                as: project_id
            podLabels:
              - name: app.kubernetes.io/name
                as: app_name
    asserts:
      - isKind:
          of: ConfigMap
      - matchSnapshot:
          path: data["config.alloy"]
