---
cluster:
  name: database-observability-gc-feature-test

destinations:
  - name: grafana-cloud-metrics
    type: prometheus
    url: https://prometheus-prod-13-prod-us-east-0.grafana.net/api/prom/push
    auth:
      type: basic
      usernameKey: metricsUser
      passwordKey: grafanaCloudAccessPolicyToken
    secret:
      create: false
      name: grafana-cloud-credentials
  - name: grafana-cloud-logs
    type: loki
    url: https://logs-prod-006.grafana.net/loki/api/v1/push
    auth:
      type: basic
      usernameKey: logsUser
      passwordKey: grafanaCloudAccessPolicyToken
    secret:
      create: false
      name: grafana-cloud-credentials

alloy-singleton:
  enabled: true
  alloy:
    stabilityLevel: experimental
  includeDestinations: [grafana-cloud-metrics, grafana-cloud-logs]
  extraConfig: |
    remote.kubernetes.secret "test_database" {
      name      = "test-database-mysql"
      namespace = "mysql"
    }

    prometheus.exporter.mysql "test_database" {
      data_source_name = string.format("%s:%s@(%s:%d)/",
        convert.nonsensitive(remote.kubernetes.secret.test_database.data["mysql-username"]),
        convert.nonsensitive(remote.kubernetes.secret.test_database.data["mysql-root-password"]),
        "test-database-mysql.mysql.svc",
        3306,
      )
      enable_collectors = ["perf_schema.eventsstatements", "perf_schema.eventswaits"]
      perf_schema.eventsstatements {
        text_limit = 2048
      }
    }

    database_observability.mysql "test_database" {
      data_source_name = string.format("%s:%s@(%s:%d)/",
        convert.nonsensitive(remote.kubernetes.secret.test_database.data["mysql-username"]),
        convert.nonsensitive(remote.kubernetes.secret.test_database.data["mysql-root-password"]),
        "test-database-mysql.mysql.svc",
        3306,
      )
      forward_to = [loki.write.grafana_cloud_logs.receiver]
    }
    
    prometheus.scrape "test_database" {
      targets    = concat(
        prometheus.exporter.mysql.test_database.targets,
        database_observability.mysql.test_database.targets,
      )
      job_name   = "integrations/db-o11y"
      forward_to = [prometheus.remote_write.grafana_cloud_metrics.receiver]
    }
