---
suite: Test Pre-delete hook functionality
templates:
  - templates/hooks/pre-delete_remove-alloy-and-finalizer.yaml
tests:
  - it: should create hook when operator is deployed and readiness is enabled
    set:
      alloy-operator:
        deploy: true
        waitForAlloyRemoval:
          enabled: true
      alloy-metrics:
        enabled: true
        extraConfig: ""
    asserts:
      - hasDocuments:
          count: 4
      - documentIndex: 0
        matchSnapshot:
          path: spec

  - it: should not create hook when operator is not deployed
    set:
      alloy-operator:
        deploy: false
        waitForAlloyRemoval:
          enabled: true
      clusterMetrics:
        enabled: true
      destinations:
        - name: prometheus
          type: prometheus
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create hook when readiness wait is disabled
    set:
      alloy-operator:
        deploy: true
        waitForAlloyRemoval:
          enabled: false
      clusterMetrics:
        enabled: true
      destinations:
        - name: prometheus
          type: prometheus
    asserts:
      - hasDocuments:
          count: 0

  - it: should configure resources when provided
    set:
      alloy-operator:
        deploy: true
        waitForAlloyRemoval:
          enabled: true
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 128Mi
    asserts:
      - documentIndex: 0
        equal:
          path: "spec.template.spec.containers[0].resources.requests.cpu"
          value: 10m
      - documentIndex: 0
        equal:
          path: "spec.template.spec.containers[0].resources.limits.memory"
          value: 128Mi
