{{- range $collectorName := include "collectors.list.enabled" . | fromYamlArray }}
{{- include "crdValidation" $ }}
{{- $values := (deepCopy $ | merge (dict "collectorName" $collectorName)) }}
{{- $alloyValues := (include "collector.alloy.values" $values | fromYaml) | merge (dict "nameOverride" $collectorName) }}
{{- $alloySpec := include "collector.alloy.valuesToSpec" $alloyValues }}
---
apiVersion: collectors.grafana.com/v1alpha1
kind: Alloy
metadata:
  name: {{ include "collector.alloy.fullname" $values }}
  namespace: {{ $.Release.Namespace }}
  {{- if and (index $.Values "alloy-operator").deploy (index $.Values "alloy-operator").waitForReadiness.enabled }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sdk.operatorframework.io/uninstall-wait: "true"
  {{- end }}
spec:{{ $alloySpec | trim | nindent 2 }}
{{- end }}
