{{- range $destination := .Values.destinations }}
{{- if eq $destination.type "otlp" }}
  {{- $isSamplingEnabled := include "destinations.otlp.is_tail_sampling_enabled" $destination }}
  {{- if eq $isSamplingEnabled "true" }}

    {{- $defaultValues := "destinations/otlp-values.yaml" | $.Files.Get | fromYaml }}
    {{- $destination = mergeOverwrite $defaultValues $destination }}

    {{- $traces := list }}
    {{- $traces = append $traces "otelcol.processor.tail_sampling.sampler.input" }}
    {{- $receiverConfig := include "sampler.receiver.otlp.alloy" $traces }}
    {{- $samplerConfig := include "sampler.processor.tail_sampling" $destination.processors.tail_sampling | trim }}

    {{- $alloyConfig := "" }}
    {{- $alloyConfig = cat $alloyConfig ((include "destinations.alloy.config" (deepCopy $ | merge (dict "names" (list $destination.name)))) | trim | nindent 0) }}
    {{- $alloyConfig = regexReplaceAll `[ \t]+(\r?\n)` $alloyConfig "\n" }}
---
apiVersion: collectors.grafana.com/v1alpha1
kind: Alloy
metadata:
  name: {{ printf "%s-%s-sampler" $.Release.Name $destination.name }}
  namespace: {{ $.Release.Namespace }}
spec:
  controller:
    type: statefulset
    replicas: 1
  alloy:
    configMap:
      create: true
      content: |
        {{- $receiverConfig | trim | nindent 8 }}
        {{ $samplerConfig | trim | nindent 8 }}
        {{ $alloyConfig | trim | nindent 8 }}
{{- end }}
{{- end }}
{{- end }}
