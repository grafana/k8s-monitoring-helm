{{ define "alloy.config.metricsServiceRemoteWrite" }}
{{- with .Values.externalServices.prometheus }}
prometheus.remote_write "metrics_service" {
  endpoint {
    url = nonsensitive(remote.kubernetes.secret.metrics_service.data[{{ .hostKey | quote }}]) + "{{ .writeEndpoint }}"
    headers = { "X-Scope-OrgID" = nonsensitive(remote.kubernetes.secret.metrics_service.data[{{ .tenantIdKey | quote }}]) }
{{- if .proxyURL }}
    proxy_url = {{ .proxyURL | quote }}
{{- end }}
{{ if eq .authMode "basic" }}
    basic_auth {
      username = nonsensitive(remote.kubernetes.secret.metrics_service.data[{{ .basicAuth.usernameKey | quote }}])
      password = remote.kubernetes.secret.metrics_service.data[{{ .basicAuth.passwordKey | quote }}]
    }
{{- end }}
{{ if .writeRelabelConfigRules }}
{{ .writeRelabelConfigRules | indent 4 }}
{{- end }}
{{- if .tls }}
    tls_config {
    {{- range $k, $v := .tls }}
      {{ $k }} = {{ $v | toJson }}
    {{- end }}
    }
{{- end }}
    send_native_histograms = {{ .sendNativeHistograms }}
  }

  wal {
    truncate_frequency = {{ .wal.truncateFrequency | quote }}
    min_keepalive_time = {{ .wal.minKeepaliveTime | quote }}
    max_keepalive_time = {{ .wal.maxKeepaliveTime | quote }}
  }

  external_labels = {
  {{- range $key, $value := .externalLabels }}
    {{ $key }} = {{ $value | quote }},
  {{- end }}
{{- end }}
  }
}
{{ end }}
