apiVersion: dashboard.grafana.app/v2beta1
kind: Dashboard
metadata:
  name: istio-logs
spec:
  annotations:
    - kind: AnnotationQuery
      spec:
        builtIn: true
        enable: true
        hide: true
        iconColor: rgba(0, 211, 255, 1)
        name: Annotations & Alerts
        query:
          group: grafana
          kind: DataQuery
          spec: {}
          version: v0
  cursorSync: 'Off'
  editable: false
  elements:
    panel-1:
      kind: Panel
      spec:
        data:
          kind: QueryGroup
          spec:
            queries:
              - kind: PanelQuery
                spec:
                  hidden: false
                  query:
                    datasource:
                      name: ${loki_datasource}
                    group: loki
                    kind: DataQuery
                    spec:
                      expr: >
                        sum by (response_code)
                        (count_over_time({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type",protocol=~"$protocol",request_method=~"$request_method",response_code=~"$response_code",level=~"$level"}

                        |~ "$regex_search"


                        [$__interval]))
                      legendFormat: '{{ response_code }}'
                    version: v0
                  refId: A
            queryOptions:
              interval: 30s
            transformations:
              - kind: renameByRegex
                spec:
                  id: renameByRegex
                  options:
                    regex: Value
                    renamePattern: logs
        description: Logs volume grouped by "response_code" label.
        id: 1
        links: []
        title: Logs volume
        vizConfig:
          group: timeseries
          kind: VizConfig
          spec:
            fieldConfig:
              defaults:
                color:
                  mode: palette-classic
                custom:
                  axisBorderShow: false
                  axisCenteredZero: false
                  axisColorMode: text
                  axisLabel: ''
                  axisPlacement: auto
                  barAlignment: 0
                  barWidthFactor: 0.6
                  drawStyle: bars
                  fillOpacity: 50
                  gradientMode: none
                  hideFrom:
                    legend: false
                    tooltip: false
                    viz: false
                  insertNulls: false
                  lineInterpolation: linear
                  lineWidth: 1
                  pointSize: 5
                  scaleDistribution:
                    type: linear
                  showPoints: auto
                  showValues: false
                  spanNulls: false
                  stacking:
                    group: A
                    mode: normal
                  thresholdsStyle:
                    mode: 'off'
                thresholds:
                  mode: absolute
                  steps:
                    - color: green
                      value: 0
                    - color: red
                      value: 80
                unit: none
              overrides:
                - matcher:
                    id: byRegexp
                    options: (E|e)merg|(F|f)atal|(A|a)lert|(C|c)rit.*
                  properties:
                    - id: color
                      value:
                        fixedColor: purple
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: (E|e)(rr.*|RR.*)
                  properties:
                    - id: color
                      value:
                        fixedColor: red
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: (W|w)(arn.*|ARN.*|rn|RN)
                  properties:
                    - id: color
                      value:
                        fixedColor: orange
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: (N|n)(otice|ote)|(I|i)(nf.*|NF.*)
                  properties:
                    - id: color
                      value:
                        fixedColor: green
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: dbg.*|DBG.*|(D|d)(EBUG|ebug)
                  properties:
                    - id: color
                      value:
                        fixedColor: blue
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: (T|t)(race|RACE)
                  properties:
                    - id: color
                      value:
                        fixedColor: light-blue
                        mode: fixed
                - matcher:
                    id: byRegexp
                    options: logs
                  properties:
                    - id: color
                      value:
                        fixedColor: text
                        mode: fixed
            options:
              legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
              tooltip:
                hideZeros: false
                mode: multi
                sort: desc
          version: 12.4.0-19938312174
    panel-2:
      kind: Panel
      spec:
        data:
          kind: QueryGroup
          spec:
            queries:
              - kind: PanelQuery
                spec:
                  hidden: false
                  query:
                    datasource:
                      name: ${loki_datasource}
                    group: loki
                    kind: DataQuery
                    spec:
                      expr: >+
                        {job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type",protocol=~"$protocol",request_method=~"$request_method",response_code=~"$response_code",level=~"$level"} 

                        |~ "$regex_search"


                    version: v0
                  refId: A
            queryOptions: {}
            transformations: []
        description: ''
        id: 2
        links: []
        title: Logs
        vizConfig:
          group: logs
          kind: VizConfig
          spec:
            fieldConfig:
              defaults: {}
              overrides: []
            options:
              dedupStrategy: exact
              enableInfiniteScrolling: false
              enableLogDetails: true
              prettifyLogMessage: true
              showControls: false
              showTime: false
              sortOrder: Descending
              wrapLogMessage: false
          version: 12.4.0-19938312174
    panel-3:
      kind: Panel
      spec:
        data:
          kind: QueryGroup
          spec:
            queries:
              - kind: PanelQuery
                spec:
                  hidden: false
                  query:
                    group: loki
                    kind: DataQuery
                    spec:
                      expr: |
                        sum(count_over_time({job=~"$job"}[5m]))
                    version: v0
                  refId: A
            queryOptions: {}
            transformations: []
        description: Shows if logs are being received for the selected time range.
        id: 3
        links: []
        title: Logs
        vizConfig:
          group: stat
          kind: VizConfig
          spec:
            fieldConfig:
              defaults:
                color:
                  fixedColor: text
                  mode: fixed
                mappings:
                  - options:
                      match: 'null'
                      result:
                        color: light-yellow
                        index: 0
                        text: Failed to collect logs or no logs available
                    type: special
                  - options:
                      from: 0
                      result:
                        color: light-yellow
                        index: 1
                        text: Failed to collect logs or no logs available
                      to: 0
                    type: range
                  - options:
                      from: 1
                      result:
                        color: light-green
                        index: 2
                        text: Receiving logs
                      to: 1000000
                    type: range
                noValue: No data
                thresholds:
                  mode: absolute
                  steps:
                    - color: green
                      value: 0
                    - color: red
                      value: 80
                unit: string
              overrides: []
            options:
              colorMode: background
              graphMode: none
              justifyMode: auto
              orientation: auto
              percentChangeColorMode: standard
              reduceOptions:
                calcs:
                  - lastNotNull
                fields: ''
                values: false
              showPercentChange: false
              textMode: auto
              wideLayout: true
          version: 12.4.0-19938312174
    panel-4:
      kind: Panel
      spec:
        data:
          kind: QueryGroup
          spec:
            queries:
              - kind: PanelQuery
                spec:
                  hidden: false
                  query:
                    group: loki
                    kind: DataQuery
                    spec:
                      expr: |
                        sum(count_over_time({job=~"$job"}[5m]))
                    version: v0
                  refId: A
            queryOptions:
              timeFrom: now-24h
            transformations: []
        description: >-
          Shows the timestamp of the latest logs received for this integration
          in the last 24 hours.
        id: 4
        links: []
        title: Latest logs received
        vizConfig:
          group: stat
          kind: VizConfig
          spec:
            fieldConfig:
              defaults:
                color:
                  fixedColor: text
                  mode: fixed
                noValue: No data
                thresholds:
                  mode: absolute
                  steps:
                    - color: green
                      value: 0
                    - color: red
                      value: 80
                unit: dateTimeFromNow
              overrides: []
            options:
              colorMode: background
              graphMode: none
              justifyMode: auto
              orientation: auto
              percentChangeColorMode: standard
              reduceOptions:
                calcs:
                  - lastNotNull
                fields: Time
                values: false
              showPercentChange: false
              textMode: auto
              wideLayout: true
          version: 12.4.0-19938312174
    panel-5:
      kind: Panel
      spec:
        data:
          kind: QueryGroup
          spec:
            queries:
              - kind: PanelQuery
                spec:
                  hidden: false
                  query:
                    group: ''
                    kind: DataQuery
                    spec: {}
                    version: v0
                  refId: A
            queryOptions: {}
            transformations: []
        description: Shows the installed version of this integration.
        id: 5
        links: []
        title: Integration version
        vizConfig:
          group: stat
          kind: VizConfig
          spec:
            fieldConfig:
              defaults:
                color:
                  fixedColor: text
                  mode: fixed
                noValue: 1.0.2
                thresholds:
                  mode: absolute
                  steps:
                    - color: green
                      value: 0
                    - color: red
                      value: 80
                unit: string
              overrides: []
            options:
              colorMode: value
              graphMode: area
              justifyMode: auto
              orientation: auto
              percentChangeColorMode: standard
              reduceOptions:
                calcs:
                  - lastNotNull
                fields: ''
                values: false
              showPercentChange: false
              textMode: auto
              wideLayout: true
          version: 12.4.0-19938312174
  layout:
    kind: GridLayout
    spec:
      items:
        - kind: GridLayoutItem
          spec:
            element:
              kind: ElementReference
              name: panel-3
            height: 2
            width: 8
            x: 0
            'y': 0
        - kind: GridLayoutItem
          spec:
            element:
              kind: ElementReference
              name: panel-4
            height: 2
            width: 8
            x: 8
            'y': 0
        - kind: GridLayoutItem
          spec:
            element:
              kind: ElementReference
              name: panel-5
            height: 2
            width: 8
            x: 16
            'y': 0
        - kind: GridLayoutItem
          spec:
            element:
              kind: ElementReference
              name: panel-1
            height: 6
            width: 24
            x: 0
            'y': 2
        - kind: GridLayoutItem
          spec:
            element:
              kind: ElementReference
              name: panel-2
            height: 18
            width: 24
            x: 0
            'y': 8
  links:
    - asDropdown: false
      icon: ''
      includeVars: false
      keepTime: true
      tags: []
      targetBlank: false
      title: Istio overview
      tooltip: ''
      type: link
      url: /d/istio-overview
    - asDropdown: false
      icon: ''
      includeVars: false
      keepTime: true
      tags: []
      targetBlank: false
      title: Istio services overview
      tooltip: ''
      type: link
      url: /d/istio-services-overview
    - asDropdown: false
      icon: ''
      includeVars: false
      keepTime: true
      tags: []
      targetBlank: false
      title: Istio workloads overview
      tooltip: ''
      type: link
      url: /d/istio-workloads-overview
  liveNow: false
  preload: false
  tags:
    - istio-integration
  timeSettings:
    autoRefresh: 30s
    autoRefreshIntervals:
      - 5s
      - 10s
      - 30s
      - 1m
      - 5m
      - 15m
      - 30m
      - 1h
      - 2h
      - 1d
    fiscalYearStartMonth: 0
    from: now-30m
    hideTimepicker: false
    timezone: default
    to: now
  title: Istio logs
  variables:
    - kind: DatasourceVariable
      spec:
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: false
        label: Loki data source
        multi: false
        name: loki_datasource
        options: []
        pluginId: loki
        refresh: onDashboardLoad
        regex: (?!grafanacloud.+usage-insights|grafanacloud.+alert-state-history).+
        skipUrlSync: false
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Job
        multi: true
        name: job
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: label_values({job=~"integrations/istio"}, job)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Cluster
        multi: true
        name: cluster
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: label_values({job=~"integrations/istio",job=~"$job"}, cluster)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Pod
        multi: true
        name: pod
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster"},
              pod)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Log_type
        multi: true
        name: log_type
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod"},
              log_type)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Protocol
        multi: true
        name: protocol
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type"},
              protocol)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Request_method
        multi: true
        name: request_method
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type",protocol=~"$protocol"},
              request_method)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Response_code
        multi: true
        name: response_code
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type",protocol=~"$protocol",request_method=~"$request_method"},
              response_code)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: QueryVariable
      spec:
        allValue: .*
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: dontHide
        includeAll: true
        label: Level
        multi: true
        name: level
        options: []
        query:
          datasource:
            name: ${loki_datasource}
          group: loki
          kind: DataQuery
          spec:
            __legacyStringValue: >-
              label_values({job=~"integrations/istio",job=~"$job",cluster=~"$cluster",pod=~"$pod",log_type=~"$log_type",protocol=~"$protocol",request_method=~"$request_method",response_code=~"$response_code"},
              level)
          version: v0
        refresh: onTimeRangeChanged
        regex: ''
        skipUrlSync: false
        sort: alphabeticalAsc
    - kind: TextVariable
      spec:
        current:
          text: ''
          value: ''
        hide: dontHide
        label: Regex search
        name: regex_search
        query: ''
        skipUrlSync: false
    - kind: DatasourceVariable
      spec:
        allowCustomValue: true
        current:
          text: ''
          value: ''
        hide: hideVariable
        includeAll: false
        label: Data source
        multi: false
        name: datasource
        options: []
        pluginId: prometheus
        refresh: onDashboardLoad
        regex: (?!grafanacloud-usage|grafanacloud-ml-metrics).+
        skipUrlSync: false
status: {}
