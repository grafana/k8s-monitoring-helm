# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Test existing secret
templates:
  - deployment.yaml
  - secret.yaml
tests:
  - it: should not create secret when using existing secret
    set:
      enabled: true
      credentials.createSecret: false
      credentials.existingSecret: "my-existing-secret"
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create deployment with existing secret reference
    set:
      enabled: true
      credentials.createSecret: false
      credentials.existingSecret: "my-existing-secret"
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: release-name-feature-private-datasource-connect
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GCLOUD_PDC_SIGNING_TOKEN
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: token
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GCLOUD_HOSTED_GRAFANA_ID
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: hosted-grafana-id
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GCLOUD_PDC_CLUSTER
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: cluster
