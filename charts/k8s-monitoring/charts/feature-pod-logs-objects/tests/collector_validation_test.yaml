---
suite: Test - PodLogs Objects - Collector Validation
templates:
  - test/collector.yaml
tests:
  - it: should fail when DaemonSet is not in clustering mode
    set:
      testing: true
      test:
        Collector:
          alloy:
            clustering:
              enabled: false
          controller:
            type: daemonset
    asserts:
      - failedTemplate:
          errorMessage: |-
            PodLogs Objects feature requires Alloy DaemonSet to be in clustering mode.
            Please set:
            alloy-test:
              alloy:
                clustering:
                  enabled: true

  - it: should fail when multiple replicas exist without clustering
    set:
      testing: true
      test:
        Collector:
          alloy:
            clustering:
              enabled: false
          controller:
            type: deployment
            replicas: 2
    asserts:
      - failedTemplate:
          errorMessage: |-
            PodLogs Objects feature requires Alloy with multiple replicas to be in clustering mode.
            Please set:
            alloy-test:
              alloy:
                clustering:
                  enabled: true

  - it: should fail when secretFilter is enabled without experimental stability level
    set:
      testing: true
      secretFilter:
        enabled: true
      test:
        Collector:
          alloy:
            clustering:
              enabled: true
            stabilityLevel: generally-available
          controller:
            type: daemonset
    asserts:
      - failedTemplate:
          errorMessage: |-
            PodLogs Objects feature requires Alloy to use the experimental stability level when using the secretFilter.
            Please set:
            alloy-test:
              alloy:
                stabilityLevel: experimental

  - it: should fail when nodeFilter is enabled on non-DaemonSet deployments
    set:
      testing: true
      nodeFilter: true
      test:
        Collector:
          alloy:
            clustering:
              enabled: true
          controller:
            type: deployment
    asserts:
      - failedTemplate:
          errorMessage: |-
            PodLogs Objects feature requires Alloy to be a DaemonSet when using nodeFilter.
            Please set:
            alloy-test:
              controller:
                type: daemonset
