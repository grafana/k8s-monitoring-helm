# yamllint disable rule:document-start rule:line-length rule:trailing-spaces
suite: Test PostgreSQL w/ DB O11y - Metrics
templates:
  - configmap.yaml
  - postgresql-secret.yaml
tests:
  - it: should create the PostgreSQL config
    set:
      deployAsConfigMap: true
      postgresql:
        instances:
          - name: my-database
            exporter:
              dataSource:
                host: my-db.postgresql.svc
                auth:
                  username: db-admin
                  password: db-password
            databaseObservability:
              enabled: true
            logs: {enabled: false}
    asserts:
      - template: configmap.yaml
        matchSnapshot:
          path: data["metrics.alloy"]

      - template: postgresql-secret.yaml
        documentIndex: 0
        containsDocument:
          apiVersion: v1
          kind: Secret
          name: my-database-release-name-feature-integrations
          namespace: NAMESPACE
      - template: postgresql-secret.yaml
        equal:
          path: stringData.username
          value: db-admin
      - template: postgresql-secret.yaml
        equal:
          path: stringData.password
          value: db-password

  - it: works with multiple PostgreSQL Instances
    set:
      deployAsConfigMap: true
      postgresql:
        instances:
          - name: test-db
            exporter:
              dataSource:
                host: database.test.svc
            databaseObservability:
              enabled: true
            logs: {enabled: false}
          - name: staging-db
            exporter:
              dataSourceName: "root:password@database.staging.svc:3306/"
            databaseObservability:
              enabled: true
            logs: {enabled: false}
          - name: prod-db
            exporter:
              dataSource:
                host: database.prod.svc
                auth:
                  username: db-admin
                  password: db-password
            databaseObservability:
              enabled: true
            logs: {enabled: false}
    asserts:
      - template: configmap.yaml
        matchSnapshot:
          path: data["metrics.alloy"]

      - template: postgresql-secret.yaml
        hasDocuments:
          count: 1  # Only one secret should be created
      - template: postgresql-secret.yaml
        documentIndex: 0
        containsDocument:
          apiVersion: v1
          kind: Secret
          name: prod-db-release-name-feature-integrations
          namespace: NAMESPACE
      - template: postgresql-secret.yaml
        equal:
          path: stringData.username
          value: db-admin
      - template: postgresql-secret.yaml
        equal:
          path: stringData.password
          value: db-password

  - it: requires metrics
    set:
      deployAsConfigMap: true
      postgresql:
        instances:
          - name: test-database
            metrics: {enabled: false}
            logs: {enabled: false}
            databaseObservability:
              enabled: true
    asserts:
      - template: configmap.yaml
        failedTemplate:
          errorMessage: |-
            Enabling Database Observability for PostgreSQL requires exporter metrics.
            Please set:
            integrations:
              postgresql:
                instances:
                  - name: test-database
                    metrics:
                      enabled: true
